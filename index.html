<!DOCTYPE html>
<html lang="en">
<head> 
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ETS Duct Length Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    h2 { text-align: center; }
    label { display: block; margin-top: 10px; }
    input, textarea, select { width: 100%; padding: 8px; margin-top: 4px; }
    button { margin-top: 20px; padding: 10px; width: 100%; font-size: 16px; }
    .results { margin-top: 20px; background: #f3f3f3; padding: 15px; border-radius: 5px; }
    .results div { margin-bottom: 10px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>ETS Duct Length Calculator</h2>

  <div id="initialForm">
    <label for="tx">TX Number</label>
    <input type="text" id="tx" placeholder="e.g. TX1">

    <label for="trenchLength">Trench Length to First Row (m)</label>
    <input type="number" id="trenchLength" placeholder="e.g. 15">

    <label for="numRows">Number of Rows (Tables)</label>
    <input type="number" id="numRows" placeholder="e.g. 5">

    <label for="rowSpacing">Distance Between Rows (m)</label>
    <input type="number" id="rowSpacing" placeholder="e.g. 6">

    <button onclick="startRowInputs()">Start Row Input</button>
  </div>

  <div id="rowInputForm" class="hidden">
    <h3 id="rowTitle">Row 1</h3>
    <label for="inverters">Inverter(s) on this row (comma-separated)</label>
    <input type="text" id="inverters" placeholder="e.g. 1.1.1,1.1.2">

    <label for="combiner">AC Combiner on this row (optional)</label>
    <input type="text" id="combiner" placeholder="e.g. 1.1">

    <button onclick="saveRowData()">Save Row</button>
  </div>

  <div class="results" id="results"></div>

  <script>
    let currentRow = 1;
    let totalRows = 0;
    let trenchLength = 0;
    let rowSpacing = 0;
    let rowData = [];

    function startRowInputs() {
      totalRows = parseInt(document.getElementById('numRows').value);
      trenchLength = parseFloat(document.getElementById('trenchLength').value);
      rowSpacing = parseFloat(document.getElementById('rowSpacing').value);
      document.getElementById('initialForm').classList.add('hidden');
      document.getElementById('rowInputForm').classList.remove('hidden');
      document.getElementById('rowTitle').textContent = `Row ${currentRow}`;
    }

    function saveRowData() {
      const inverters = document.getElementById('inverters').value.trim();
      const combiner = document.getElementById('combiner').value.trim();
      rowData.push({ row: currentRow, inverters: inverters.split(',').map(i => i.trim()).filter(Boolean), combiner });

      currentRow++;
      document.getElementById('inverters').value = '';
      document.getElementById('combiner').value = '';

      if (currentRow <= totalRows) {
        document.getElementById('rowTitle').textContent = `Row ${currentRow}`;
      } else {
        document.getElementById('rowInputForm').classList.add('hidden');
        calculateDuctLengths();
      }
    }

    function calculateDuctLengths() {
      let commsLength = trenchLength + 3;
      let inverters = [];
      let combinerBoxes = [];

      rowData.forEach((row, i) => {
        row.inverters.forEach((inv, idx) => {
          commsLength += (idx < row.inverters.length - 1 || i < rowData.length - 1) ? 6 : 3;
          inverters.push({ name: inv, row: i });
        });
        if (row.combiner) combinerBoxes.push({ name: row.combiner, row: i });
        if (i < rowData.length - 1) commsLength += rowSpacing;
      });

      const commsReels = Math.ceil(commsLength / 50);
      const acTransferLength = combinerBoxes.reduce((sum, cb) => sum + trenchLength + cb.row * rowSpacing + 6, 0);
      const acTransferReels = Math.ceil(acTransferLength / 50);

      let acInverterLength = 0;
      combinerBoxes.forEach(cb => {
        inverters.filter(inv => inv.name.startsWith(cb.name)).forEach(inv => {
          const rowDiff = Math.abs(cb.row - inv.row);
          acInverterLength += rowDiff * rowSpacing + 6;
        });
      });
      const acInverterReels = Math.ceil(acInverterLength / 50);

      const stringDucts = totalRows - 1;
      const stringDuctLength = stringDucts * (rowSpacing + 6);
      const stringDuctReels = Math.ceil(stringDuctLength / 50);

      document.getElementById('results').innerHTML = `
        <h3>Results</h3>
        <div><strong>Comms Duct (50mm):</strong> ${commsLength} m → ${commsReels} × 50m reels</div>
        <div><strong>Main AC Transfer (110mm):</strong> ${acTransferLength} m → ${acTransferReels} × 50m reels</div>
        <div><strong>AC Inverter Feeds (50mm):</strong> ${acInverterLength} m → ${acInverterReels} × 50m reels</div>
        <div><strong>String Ducts (110mm):</strong> ${stringDuctLength} m → ${stringDuctReels} × 50m reels</div>
      `;
    }
  </script>
</body>
</html>
